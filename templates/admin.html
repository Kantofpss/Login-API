<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Administração</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .form-container { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Painel de Administração</h1>

    <section>
        <h2>Autenticação</h2>
        <button id="load-users">Carregar Usuários</button>
    </section>

    <section class="form-container">
        <h2>Criar Novo Usuário</h2>
        <form id="create-user-form">
            <label for="new-username">Usuário:</label><br>
            <input type="text" id="new-username" name="new-username" required><br><br>
            <label for="new-password">Senha:</label><br>
            <input type="password" id="new-password" name="new-password" required><br><br>
            <button type="submit">Criar Usuário</button>
        </form>
    </section>

    <section>
        <h2>Gerenciamento de Usuários</h2>
        <table>
            <thead>
                <tr>
                    <th>Usuário</th>
                    <th>HWID Registrado</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
            </tbody>
        </table>
    </section>

    <script>
        document.getElementById('load-users').addEventListener('click', async () => {
            try {
                const response = await fetch('/admin/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: 'admin123' })
                });

                if (!response.ok) {
                    throw new Error('Falha na autenticação ou erro no servidor.');
                }

                const users = await response.json();
                const tableBody = document.getElementById('user-table-body');
                tableBody.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.hwid || 'Nenhum'}</td>
                        <td><button onclick="resetHwid('${user.username}')">Resetar HWID</button></td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                alert(`Erro ao carregar usuários: ${error.message}`);
            }
        });

        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;

            try {
                const response = await fetch('/admin/api/create_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: 'admin123', username: username, password_user: password })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.success);
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('load-users').click(); // Recarrega a tabela
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert(`Erro ao criar usuário: ${error.message}`);
            }
        });

        async function resetHwid(username) {
            try {
                const response = await fetch('/admin/api/reset_hwid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: 'admin123', username: username })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.success);
                    document.getElementById('load-users').click(); // Recarrega a tabela
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert(`Erro ao resetar HWID: ${error.message}`);
            }
        }
    </script>
</body>
</html>